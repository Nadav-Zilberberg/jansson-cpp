#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <cerrno>
#include <cassert>
#include <csignal>
#include <csetjmp>
#include <cstdarg>
#include <cstddef>
#include <cwctype>
#include <cwchar>
#include <cctype>
#include <ctime>
#include <cfloat>
#include <climits>
#include <cstdint>
#include <cmath>
#include <cstdlib>
#include <cstdio>
#include <cerrno>
#include <cstring>
#include <algorithm>
#define JSON_PARSER_MAX_DEPTH 2048
#include <sys/time.h>
#include <unistd.h>
#include <stdexcept>
#include "jansson.hpp"
#include "jansson_private.hpp"

namespace jansson {

struct Impl {
    json_t* handle;
    
    Impl() : handle(nullptr) {}
    explicit Impl(json_t* h) : handle(h) {}
    ~Impl() {
        if (handle) {
            json_decref(handle);
        }
    }
    
    // Disable copy operations
    Impl(const Impl&) = delete;
    Impl& operator=(const Impl&) = delete;
    
    // Enable move operations
    Impl(Impl&& other) noexcept : handle(other.handle) {
        other.handle = nullptr;
    }
    Impl& operator=(Impl&& other) noexcept {
        if (this != &other) {
            if (handle) {
                json_decref(handle);
            }
            handle = other.handle;
            other.handle = nullptr;
        }
        return *this;
    }
};

Json::Json() : pImpl(std::make_unique<Impl>()) {}

Json::Json(const Json& other) : pImpl(std::make_unique<Impl>()) {
    if (other.pImpl->handle) {
        pImpl->handle = json_incref(other.pImpl->handle);
    }
}

Json::Json(Json&& other) noexcept = default;

Json::~Json() = default;

Json& Json::operator=(const Json& other) {
    if (this != &other) {
        pImpl = std::make_unique<Impl>();
        if (other.pImpl->handle) {
            pImpl->handle = json_incref(other.pImpl->handle);
        }
    }
    return *this;
}

Json& Json::operator=(Json&& other) noexcept = default;

void Json::parse(const std::string& jsonText) {
    json_error_t error;
    json_t* result = json_loads(jsonText.c_str(), 0, &error);
    if (!result) {
        throw std::runtime_error("Failed to parse JSON: " + std::string(error.text));
    }
    pImpl->handle = result;
}

std::string Json::dump() const {
    if (!pImpl->handle) {
        return "";
    }
    char* result = json_dumps(pImpl->handle, JSON_COMPACT);
    std::string str(result);
    free(result);
    return str;
}

bool Json::isObject() const { return pImpl->handle && json_is_object(pImpl->handle); }
bool Json::isArray() const { return pImpl->handle && json_is_array(pImpl->handle); }
bool Json::isString() const { return pImpl->handle && json_is_string(pImpl->handle); }
bool Json::isInteger() const { return pImpl->handle && json_is_integer(pImpl->handle); }
bool Json::isReal() const { return pImpl->handle && json_is_real(pImpl->handle); }
bool Json::isNumber() const { return pImpl->handle && json_is_number(pImpl->handle); }
bool Json::isTrue() const { return pImpl->handle && json_is_true(pImpl->handle); }
bool Json::isFalse() const { return pImpl->handle && json_is_false(pImpl->handle); }
bool Json::isBoolean() const { return pImpl->handle && json_is_boolean(pImpl->handle); }
bool Json::isNull() const { return pImpl->handle && json_is_null(pImpl->handle); }

size_t Json::objectSize() const {
    return pImpl->handle ? json_object_size(pImpl->handle) : 0;
}

Json Json::objectGet(const std::string& key) const {
    if (!pImpl->handle) {
        return Json();
    }
    json_t* result = json_object_get(pImpl->handle, key.c_str());
    return Json(result ? json_incref(result) : nullptr);
}

void Json::objectSet(const std::string& key, const Json& value) {
    if (!pImpl->handle) {
        pImpl->handle = json_object();
    }
    json_object_set(pImpl->handle, key.c_str(), value.pImpl->handle);
}

void Json::objectDel(const std::string& key) {
    if (pImpl->handle) {
        json_object_del(pImpl->handle, key.c_str());
    }
}

void Json::objectClear() {
    if (pImpl->handle) {
        json_object_clear(pImpl->handle);
    }
}

size_t Json::arraySize() const {
    return pImpl->handle ? json_array_size(pImpl->handle) : 0;
}

Json Json::arrayGet(size_t index) const {
    if (!pImpl->handle) {
        return Json();
    }
    json_t* result = json_array_get(pImpl->handle, index);
    return Json(result ? json_incref(result) : nullptr);
}

void Json::arraySet(size_t index, const Json& value) {
    if (!pImpl->handle) {
        pImpl->handle = json_array();
    }
    json_array_set(pImpl->handle, index, value.pImpl->handle);
}

void Json::arrayAppend(const Json& value) {
    if (!pImpl->handle) {
        pImpl->handle = json_array();
    }
    json_array_append(pImpl->handle, value.pImpl->handle);
}

void Json::arrayInsert(size_t index, const Json& value) {
    if (!pImpl->handle) {
        pImpl->handle = json_array();
    }
    json_array_insert(pImpl->handle, index, value.pImpl->handle);
}

void Json::arrayRemove(size_t index) {
    if (pImpl->handle) {
        json_array_remove(pImpl->handle, index);
    }
}

void Json::arrayClear() {
    if (pImpl->handle) {
        json_array_clear(pImpl->handle);
    }
}

std::string Json::stringValue() const {
    if (!pImpl->handle) {
        return "";
    }
    const char* result = json_string_value(pImpl->handle);
    return result ? std::string(result) : "";
}

size_t Json::stringLength() const {
    return pImpl->handle ? json_string_length(pImpl->handle) : 0;
}

long long Json::integerValue() const {
    return pImpl->handle ? json_integer_value(pImpl->handle) : 0;
}

double Json::realValue() const {
    return pImpl->handle ? json_real_value(pImpl->handle) : 0.0;
}

double Json::numberValue() const {
    return pImpl->handle ? json_number_value(pImpl->handle) : 0.0;
}

bool Json::booleanValue() const {
    return pImpl->handle && json_is_true(pImpl->handle);
}

void Json::stringSet(const std::string& value) {
    if (!pImpl->handle) {
        pImpl->handle = json_string(value.c_str());
    } else {
        json_string_set(pImpl->handle, value.c_str());
    }
}

void Json::integerSet(long long value) {
    if (!pImpl->handle) {
        pImpl->handle = json_integer(value);
    } else {
        json_integer_set(pImpl->handle, value);
    }
}

void Json::realSet(double value) {
    if (!pImpl->handle) {
        pImpl->handle = json_real(value);
    } else {
        json_real_set(pImpl->handle, value);
    }
}

Json Json::object() {
    Json result;
    result.pImpl->handle = json_object();
    return result;
}

Json Json::array() {
    Json result;
    result.pImpl->handle = json_array();
    return result;
}

Json Json::string(const std::string& value) {
    Json result;
    result.pImpl->handle = json_string(value.c_str());
    return result;
}

Json Json::integer(long long value) {
    Json result;
    result.pImpl->handle = json_integer(value);
    return result;
}

Json Json::real(double value) {
    Json result;
    result.pImpl->handle = json_real(value);
    return result;
}

Json Json::trueValue() {
    Json result;
    result.pImpl->handle = json_true();
    return result;
}

Json Json::falseValue() {
    Json result;
    result.pImpl->handle = json_false();
    return result;
}

Json Json::null() {
    Json result;
    result.pImpl->handle = json_null();
    return result;
}

} // namespace jansson
